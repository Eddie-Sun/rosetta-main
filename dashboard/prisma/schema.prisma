generator client {
  provider = "prisma-client-js"
  // Prisma v7 can generate the "client" engine which requires a driver adapter
  // or Accelerate. This dashboard uses the classic engine, so force it.
  engineType = "binary"
}

datasource db {
  provider  = "postgresql"
}

enum Plan {
  free
  pro
  team
  enterprise
}

enum PublishJobState {
  pending
  success
  failed
}

enum PublishJobKind {
  auth_kv_sync
}

enum SeedUrlSource {
  firecrawl_map
  manual
}

model Customer {
  id          String   @id
  clerkUserId String   @unique
  companyName String?
  plan        Plan     @default(free)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  domains     Domain[]
  apiTokens   ApiToken[]
  publishJobs PublishJob[]
  seedUrls    SeedUrl[]
  mapSnapshots MapSnapshot[]
  urlMetrics  UrlMetrics[]
}

model Domain {
  id         String   @id
  customerId String
  hostname   String
  verified   Boolean  @default(false)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  customer   Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)
  mapSnapshots MapSnapshot[]

  @@unique([customerId, hostname])
  @@index([hostname])
}

model SeedUrl {
  id         String        @id
  customerId String
  url        String
  source     SeedUrlSource
  enabled    Boolean       @default(true)
  createdAt  DateTime      @default(now())
  updatedAt  DateTime      @updatedAt

  customer   Customer      @relation(fields: [customerId], references: [id], onDelete: Cascade)

  @@unique([customerId, url])
  @@index([customerId, enabled])
}

model MapSnapshot {
  id         String   @id
  customerId String
  domainId   String
  urls       Json
  fetchedAt  DateTime
  createdAt  DateTime @default(now())

  customer   Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)
  domain     Domain   @relation(fields: [domainId], references: [id], onDelete: Cascade)

  @@unique([customerId, domainId])
  @@index([customerId, fetchedAt])
}

model ApiToken {
  id          String    @id
  customerId  String
  tokenHash   String    @unique
  tokenPrefix String
  label       String?
  revokedAt   DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  customer    Customer  @relation(fields: [customerId], references: [id], onDelete: Cascade)

  @@index([customerId])
}

model PublishJob {
  id         String          @id
  customerId String
  kind       PublishJobKind
  state      PublishJobState @default(pending)
  attempts   Int             @default(0)
  payload    Json
  lastError  String?
  createdAt  DateTime        @default(now())
  updatedAt  DateTime        @updatedAt

  customer   Customer        @relation(fields: [customerId], references: [id], onDelete: Cascade)

  @@index([state, createdAt])
  @@index([customerId])
}

model UrlMetrics {
  id          String   @id @default(uuid())
  customerId  String
  url         String
  htmlTokens  Int?
  mdTokens    Int?
  optimizedAt DateTime
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  customer    Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)

  @@unique([customerId, url])
  @@index([customerId, optimizedAt])
  @@index([customerId, url])
}


